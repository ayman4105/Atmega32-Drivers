/*
 * File   :  hal_nRF24L01.c
 * Author : AhmedShawada
 * https://www.linkedin.com/in/ahmed-shawada/
 * Created: 2/28/2025 3:12:12 PM
 */ 

#include "hal_nRF24L01.h"

void SPI_init() {
	DDRB |= (1 << PB5) | (1 << PB7) | (1 << PB4); // MOSI, SCK, SS ??????
	DDRB &= ~(1 << PB6); // MISO ??????
	SPCR = (1 << SPE) | (1 << MSTR) | (1 << SPR0); // ????? SPI ?? Master
}

uint8_t SPI_Transmit(uint8_t data) {
	SPDR = data;
	while (!(SPSR & (1 << SPIF))); // ?????? ?????? ???????
	return SPDR;
}

// ????? ??? ?? nRF24L01
void nRF24_WriteReg(uint8_t reg, uint8_t value) {
	PORTB &= ~(1 << PB4); // CSN Low
	SPI_Transmit(W_REGISTER | (REGISTER_MASK & reg));
	SPI_Transmit(value);
	PORTB |= (1 << PB4); // CSN High
}
 

void nRF24_Transmit_Process(uint8_t *data, uint8_t length) {
	// 1?? ???????? ??? ??? ?????????
	nRF24_WriteReg(CONFIG, (1 << PWR_UP) | (1 << PRIM_TX));
	_delay_ms(2); // ?????? ??????? ??????

	// 2?? ?????? ?? ??? ?????? FIFO
	uint8_t fifo_status = SPI_Transmit(FIFO_STATUS);
	if (fifo_status & (1 << TX_FULL)) {
		return; // FIFO ?????? ?? ???? ???????
	}

	// 3?? ????? ???????? ?? TX FIFO
	PORTB &= ~(1 << PB4);
	SPI_Transmit(W_TX_PAYLOAD);
	for (uint8_t i = 0; i < length; i++) {
		SPI_Transmit(data[i]);
	}
	PORTB |= (1 << PB4);

	// 4?? ????? ??????? ??? CE
	PORTB |= (1 << PB2);
	_delay_us(15);
	PORTB &= ~(1 << PB2);

	// 5?? ?????? ACK ?? ????? ???????
	uint8_t status;
	uint8_t retry_count = 0;
	while (1) {
		status = SPI_Transmit(NOP);
		
		if (status & (1 << TX_DS)) {
			// ?? ??????? ????? ??? ?????
			nRF24_WriteReg(STATUS, (1 << TX_DS));
			break;
		}
		else if (status & (1 << MAX_RT)) {
			// ?? ????? ????????
			retry_count++;
			if (retry_count >= 5) {
				// ????? ???? ?????? ?? ?????????? ??? ?????
				nRF24_WriteReg(STATUS, (1 << MAX_RT));
				break;
			}
			nRF24_WriteReg(FLUSH_TX, 0);
		}
	}
}

uint8_t nRF24_Receive_Process() {
	// 1?? ???????? ??? ??? ?????????
	nRF24_WriteReg(CONFIG, (1 << PWR_UP) | (1 << PRIM_RX));
	PORTB |= (1 << PB2); // ????? CE ?????????
	_delay_ms(2);

	while (1) {
		uint8_t status = SPI_Transmit(NOP);
		
		if (status & (1 << RX_DR)) {
			// 2?? ????? ???????? ?? RX FIFO
			uint8_t data[32];
			PORTB &= ~(1 << PB4);
			SPI_Transmit(R_RX_PAYLOAD);
			for (uint8_t i = 0; i < 32; i++) {
				data[i] = SPI_Transmit(NOP);
			}
			PORTB |= (1 << PB4);
			
			// 3?? ??? ??? ?????????
			nRF24_WriteReg(STATUS, (1 << RX_DR));

			// 4?? ????? ACK (?????? ??? ??? Auto ACK ??????)
			if (status & (1 << TX_DS)) {
				nRF24_WriteReg(STATUS, (1 << TX_DS));
			}
		}
	}
}